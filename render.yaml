services:
  - type: web
    name: whisper-transcribe
    env: python
    plan: free
    buildCommand: |
      echo "=== ビルド開始 ==="
      echo "Node.js バージョン: $(node --version)"
      echo "npm バージョン: $(npm --version)"
      echo "Python バージョン: $(python --version)"

      # フロントエンドをビルド（本番はビルド段階で作る）
      echo "=== フロントエンドビルド開始 ==="
      cd frontend
      # Rollupのネイティブモジュール問題を回避
      rm -rf node_modules package-lock.json
      # オプショナル依存関係を除外してインストール
      npm install --omit=optional --no-audit --no-fund
      # ビルドを試行（失敗した場合は手動でファイルを作成）
      npm run build || (echo "ビルドに失敗しました。フォールバックファイルを作成します。" && cd .. && chmod +x create-fallback-frontend.sh && ./create-fallback-frontend.sh && cd frontend)
      
      # フォールバックファイルが作成されたか確認
      if [ ! -f "dist/assets/index-BLqfF7NK.js" ]; then
        echo "フォールバックファイルが作成されていません。手動で作成します。"
        cd ..
        chmod +x create-fallback-frontend.sh
        ./create-fallback-frontend.sh
        cd frontend
      fi

      # フロントエンドディレクトリに戻る
      cd ..
      
      # バックエンド依存関係インストール
      echo "=== バックエンド依存関係インストール ==="
      cd backend
      pip install -r requirements.txt

      # フロントエンドのビルド結果をバックエンドディレクトリにコピー
      echo "=== フロントエンドビルド結果をコピー ==="
      cp -r ../frontend/dist ./static
      
      # 必要なファイルが存在するか確認
      echo "=== 必要なファイルの存在確認 ==="
      if [ -f "static/assets/index-BLqfF7NK.js" ]; then
        echo "必要なJavaScriptファイルが存在します"
      else
        echo "必要なJavaScriptファイルが存在しません。フォールバックファイルを作成します。"
        cd ..
        chmod +x create-fallback-frontend.sh
        ./create-fallback-frontend.sh
        cp -r frontend/dist/* backend/static/
        cd backend
      fi
      
      # 本番環境で生成される可能性のある新しいハッシュ名のファイルを確認
      echo "=== 本番環境のファイルハッシュ名を確認 ==="
      # 利用可能なJavaScriptファイルを確認
      echo "利用可能なJavaScriptファイル:"
      ls -la static/assets/*.js || echo "JavaScriptファイルがありません"
      
      # 最初に見つかったJavaScriptファイルのハッシュ名を取得
      JS_FILE=$(ls static/assets/*.js 2>/dev/null | head -1)
      if [ -n "$JS_FILE" ]; then
        JS_FILENAME=$(basename "$JS_FILE")
        echo "見つかったJavaScriptファイル: $JS_FILENAME"
        # index.htmlを新しいハッシュ名に更新（複数のパターンに対応）
        sed -i "s/index-[A-Za-z0-9]*\.js/$JS_FILENAME/g" static/index.html
        echo "index.htmlを $JS_FILENAME に更新しました"
        
        # 更新後のindex.htmlの内容を確認
        echo "=== 更新後のindex.htmlの内容 ==="
        head -10 static/index.html
      
        # CSSファイルも同様に更新
        CSS_FILE=$(ls static/assets/*.css 2>/dev/null | head -1)
        if [ -n "$CSS_FILE" ]; then
          CSS_FILENAME=$(basename "$CSS_FILE")
          echo "見つかったCSSファイル: $CSS_FILENAME"
          # index.htmlを新しいハッシュ名に更新（複数のパターンに対応）
          sed -i "s/index-[A-Za-z0-9]*\.css/$CSS_FILENAME/g" static/index.html
          echo "index.htmlのCSSを $CSS_FILENAME に更新しました"
        else
          echo "CSSファイルが見つかりません"
        fi
        
        # 最終的なindex.htmlの内容を確認
        echo "=== 最終的なindex.htmlの内容 ==="
        head -15 static/index.html
        
        # 静的ファイルの内容を確認
        echo "=== 静的ファイルの内容 ==="
        ls -la static/
        ls -la static/assets/ || echo "assetsディレクトリが見つかりません"
      else
        echo "JavaScriptファイルが見つかりません"
        # フォールバックファイルを作成
        echo "フォールバックファイルを作成します。"
        cd ..
        chmod +x create-fallback-frontend.sh
        ./create-fallback-frontend.sh
        cp -r frontend/dist/* backend/static/
        cd backend
      fi
      
      # 静的ファイルのパーミッションを確認
      echo "=== 静的ファイルのパーミッション ==="
      ls -la static/
      ls -la static/assets/ || echo "assetsディレクトリが見つかりません"
      
      # 静的ファイルのパーミッションを設定
      echo "=== 静的ファイルのパーミッションを設定 ==="
      chmod -R 644 static/
      find static/ -type d -exec chmod 755 {} \;
      
      # 静的ファイルのサイズを確認
      echo "=== 静的ファイルのサイズ ==="
      du -sh static/
      du -sh static/assets/ || echo "assetsディレクトリが見つかりません"
      
      # 静的ファイルの内容を最終確認
      echo "=== 静的ファイルの内容を最終確認 ==="
      find static/ -type f -exec echo "{}" \;
      
      # 最終的な静的ファイルの内容を確認
      echo "=== 最終的な静的ファイルの内容 ==="
      ls -la static/
      ls -la static/assets/ || echo "assetsディレクトリが見つかりません"
      
      # 最終的なindex.htmlの内容を確認
      echo "=== 最終的なindex.htmlの内容 ==="
      head -15 static/index.html || echo "index.htmlが見つかりません"
      
      # 最終的な静的ファイルの内容を確認
      echo "=== 最終的な静的ファイルの内容 ==="
      ls -la static/
      ls -la static/assets/ || echo "assetsディレクトリが見つかりません"

      echo "=== ビルド完了 ==="
    startCommand: |
      echo "=== Whisper Transcribe 起動開始 ==="
      export PYTHONPATH=./backend
      cd backend
      echo "=== バックエンド起動 ==="
      echo "=== ポート: $PORT ==="
      uvicorn app.main:app --host 0.0.0.0 --port ${PORT:-8000} --timeout-keep-alive 75
    healthCheckPath: /health
    envVars:
      - key: PYTHON_VERSION
        value: 3.11.0
      - key: NODE_VERSION
        value: 18.19.0
      - key: PORT
        value: 8000
      - key: NODE_OPTIONS
        value: "--max-old-space-size=256"
      - key: VITE_API_BASE
        value: "https://whisper-transcribe-mdxq.onrender.com"